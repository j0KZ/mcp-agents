name: Validate Skills System

on:
  push:
    paths:
      - 'docs/universal-skills/**'
      - '.github/workflows/validate-skills.yml'
  pull_request:
    paths:
      - 'docs/universal-skills/**'
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

jobs:
  validate-structure:
    name: Validate Skill Structure
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Validate skill files exist
        run: |
          echo "üîç Checking skill file structure..."

          for skill_dir in docs/universal-skills/*/; do
            if [[ -d "$skill_dir" && ! "$skill_dir" == *"scripts"* && ! "$skill_dir" == *"references"* && ! "$skill_dir" == *"workflows"* && ! "$skill_dir" == *"migrations"* ]]; then
              skill_name=$(basename "$skill_dir")
              echo "Checking $skill_name..."

              # Check for required SKILL.md
              if [[ ! -f "$skill_dir/SKILL.md" ]]; then
                echo "‚ùå Missing SKILL.md in $skill_name"
                exit 1
              fi

              # Check SKILL.md size (should be < 300 lines for v2)
              lines=$(wc -l < "$skill_dir/SKILL.md")
              if [[ $lines -gt 300 ]]; then
                echo "‚ö†Ô∏è  $skill_name/SKILL.md has $lines lines (target: <300)"
              else
                echo "‚úÖ $skill_name/SKILL.md has $lines lines"
              fi
            fi
          done

      - name: Validate YAML frontmatter
        run: |
          echo "üîç Validating YAML frontmatter..."

          for skill_file in docs/universal-skills/*/SKILL.md; do
            if [[ -f "$skill_file" ]]; then
              skill_name=$(basename $(dirname "$skill_file"))

              # Extract frontmatter
              if head -1 "$skill_file" | grep -q "^---"; then
                # Extract YAML content between --- markers
                yaml_content=$(sed -n '/^---$/,/^---$/p' "$skill_file" | sed '1d;$d')

                # Check required fields
                if echo "$yaml_content" | grep -q "^name:"; then
                  echo "‚úÖ $skill_name has name field"
                else
                  echo "‚ùå $skill_name missing name field"
                  exit 1
                fi

                if echo "$yaml_content" | grep -q "^version:"; then
                  echo "‚úÖ $skill_name has version field"
                else
                  echo "‚ö†Ô∏è  $skill_name missing version field"
                fi
              else
                echo "‚ö†Ô∏è  $skill_name has no YAML frontmatter"
              fi
            fi
          done

  validate-chains:
    name: Validate Skill Chains
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install

      - name: Validate skill chains
        run: |
          echo "üîó Validating skill chains..."

          if [[ -f docs/universal-skills/scripts/validate-skill-chains.js ]]; then
            node docs/universal-skills/scripts/validate-skill-chains.js
          else
            echo "‚ö†Ô∏è  Chain validator not found, skipping"
          fi

      - name: Check circular dependencies
        run: |
          echo "üîÑ Checking for circular dependencies..."

          # Simple check for obvious circular refs in skill-chain.json
          if [[ -f docs/universal-skills/skill-chain.json ]]; then
            # This is a simple check - the validator script does deeper analysis
            if grep -q '"modular-refactoring-pattern".*"code-quality-pipeline"' docs/universal-skills/skill-chain.json && \
               grep -q '"code-quality-pipeline".*"modular-refactoring-pattern"' docs/universal-skills/skill-chain.json; then
              echo "‚ö†Ô∏è  Potential circular dependency detected"
            else
              echo "‚úÖ No obvious circular dependencies"
            fi
          fi

  validate-versions:
    name: Validate Skill Versions
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Validate version registry
        run: |
          echo "üì¶ Validating version registry..."

          if [[ -f docs/universal-skills/scripts/manage-versions.js ]]; then
            node docs/universal-skills/scripts/manage-versions.js validate
          else
            echo "‚ö†Ô∏è  Version manager not found, skipping"
          fi

      - name: Check version consistency
        run: |
          echo "üîç Checking version consistency..."

          # Compare versions in skill-versions.json with YAML frontmatter
          if [[ -f docs/universal-skills/skill-versions.json ]]; then
            for skill_file in docs/universal-skills/*/SKILL.md; do
              if [[ -f "$skill_file" ]]; then
                skill_name=$(basename $(dirname "$skill_file"))

                # Extract version from YAML
                yaml_version=$(sed -n '/^---$/,/^---$/p' "$skill_file" | grep "^version:" | cut -d: -f2 | tr -d ' ')

                # Extract version from JSON
                if [[ -n "$yaml_version" ]]; then
                  json_version=$(grep -A2 "\"$skill_name\"" docs/universal-skills/skill-versions.json | grep "current_version" | head -1 | cut -d'"' -f4)

                  if [[ "$yaml_version" == "$json_version" ]]; then
                    echo "‚úÖ $skill_name version consistent ($yaml_version)"
                  else
                    echo "‚ö†Ô∏è  $skill_name version mismatch: YAML=$yaml_version, JSON=$json_version"
                  fi
                fi
              fi
            done
          fi

  test-workflows:
    name: Test Workflow Templates
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Validate workflow YAML
        run: |
          echo "üì¶ Validating workflow templates..."

          for workflow in docs/universal-skills/workflows/*.yml; do
            if [[ -f "$workflow" ]]; then
              workflow_name=$(basename "$workflow")
              echo "Checking $workflow_name..."

              # Basic YAML validation
              if node -e "const fs=require('fs'); const yaml=require('js-yaml'); yaml.load(fs.readFileSync('$workflow'));" 2>/dev/null; then
                echo "‚úÖ $workflow_name is valid YAML"
              else
                echo "‚ùå $workflow_name has invalid YAML"
                exit 1
              fi

              # Check required fields
              if grep -q "^name:" "$workflow" && \
                 grep -q "^steps:" "$workflow" && \
                 grep -q "^success_criteria:" "$workflow"; then
                echo "‚úÖ $workflow_name has required fields"
              else
                echo "‚ùå $workflow_name missing required fields"
                exit 1
              fi
            fi
          done

      - name: Test workflow executor
        run: |
          echo "üöÄ Testing workflow executor..."

          if [[ -f docs/universal-skills/scripts/execute-workflow.js ]]; then
            # List available workflows
            node docs/universal-skills/scripts/execute-workflow.js list

            # TODO: Add dry-run mode to test workflows without execution
            echo "‚úÖ Workflow executor operational"
          else
            echo "‚ö†Ô∏è  Workflow executor not found"
          fi

  performance-check:
    name: Performance Benchmarks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Check skill discovery performance
        run: |
          echo "‚ö° Testing skill discovery performance..."

          if [[ -f docs/universal-skills/scripts/discover-skills.js ]]; then
            # Time the discovery for common queries
            start_time=$(date +%s%N)
            node docs/universal-skills/scripts/discover-skills.js "review code" > /dev/null
            end_time=$(date +%s%N)

            duration=$((($end_time - $start_time) / 1000000))
            echo "Discovery took ${duration}ms"

            if [[ $duration -lt 100 ]]; then
              echo "‚úÖ Discovery performance excellent (<100ms)"
            elif [[ $duration -lt 500 ]]; then
              echo "‚úÖ Discovery performance good (<500ms)"
            else
              echo "‚ö†Ô∏è  Discovery performance needs optimization (${duration}ms)"
            fi
          fi

      - name: Memory usage check
        run: |
          echo "üíæ Checking memory usage..."

          # Simple memory check for loading all skills
          node -e "
            const fs = require('fs');
            const before = process.memoryUsage().heapUsed;

            // Load all skill files
            const skills = fs.readdirSync('docs/universal-skills')
              .filter(d => d !== 'scripts' && d !== 'references' && d !== 'workflows' && d !== 'migrations')
              .map(d => {
                const skillPath = 'docs/universal-skills/' + d + '/SKILL.md';
                if (fs.existsSync(skillPath)) {
                  return fs.readFileSync(skillPath, 'utf-8');
                }
              });

            const after = process.memoryUsage().heapUsed;
            const used = Math.round((after - before) / 1024 / 1024 * 100) / 100;

            console.log('Memory used for loading skills: ' + used + 'MB');

            if (used < 10) {
              console.log('‚úÖ Memory usage optimal (<10MB)');
            } else if (used < 50) {
              console.log('‚úÖ Memory usage acceptable (<50MB)');
            } else {
              console.log('‚ö†Ô∏è  High memory usage (' + used + 'MB)');
            }
          "

  generate-report:
    name: Generate Validation Report
    runs-on: ubuntu-latest
    needs: [validate-structure, validate-chains, validate-versions, test-workflows, performance-check]
    if: always()
    steps:
      - uses: actions/checkout@v6

      - name: Generate validation summary
        run: |
          echo "# üìä Skills System Validation Report" > validation-report.md
          echo "" >> validation-report.md
          echo "**Date:** $(date -u +"%Y-%m-%d %H:%M UTC")" >> validation-report.md
          echo "**Branch:** ${{ github.ref_name }}" >> validation-report.md
          echo "**Commit:** ${{ github.sha }}" >> validation-report.md
          echo "" >> validation-report.md

          echo "## Validation Results" >> validation-report.md
          echo "" >> validation-report.md

          # Count skills
          skill_count=$(find docs/universal-skills -type d -maxdepth 1 ! -name scripts ! -name references ! -name workflows ! -name migrations -name '*' | wc -l)
          echo "- **Total Skills:** $((skill_count - 1))" >> validation-report.md

          # Count workflows
          workflow_count=$(find docs/universal-skills/workflows -name "*.yml" 2>/dev/null | wc -l)
          echo "- **Workflow Templates:** ${workflow_count:-0}" >> validation-report.md

          # Count reference files
          ref_count=$(find docs/universal-skills -path "*/references/*.md" 2>/dev/null | wc -l)
          echo "- **Reference Files:** ${ref_count:-0}" >> validation-report.md

          echo "" >> validation-report.md
          echo "## Checks Performed" >> validation-report.md
          echo "" >> validation-report.md
          echo "- ‚úÖ Skill structure validation" >> validation-report.md
          echo "- ‚úÖ YAML frontmatter validation" >> validation-report.md
          echo "- ‚úÖ Chain dependency validation" >> validation-report.md
          echo "- ‚úÖ Version consistency checks" >> validation-report.md
          echo "- ‚úÖ Workflow template validation" >> validation-report.md
          echo "- ‚úÖ Performance benchmarks" >> validation-report.md

          echo "" >> validation-report.md
          echo "---" >> validation-report.md
          echo "*Generated by GitHub Actions*" >> validation-report.md

      - name: Upload validation report
        uses: actions/upload-artifact@v5
        with:
          name: skill-validation-report
          path: validation-report.md

      - name: Comment on PR (if applicable)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('validation-report.md', 'utf-8');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: report
            });