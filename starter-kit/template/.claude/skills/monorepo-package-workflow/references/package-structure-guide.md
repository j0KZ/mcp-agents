# Package Structure Guide

## Complete Directory Layout

```
packages/your-tool/
├── src/
│   ├── mcp-server.ts      # MCP protocol handler (thin, <150 LOC)
│   ├── main-logic.ts      # Core functionality
│   ├── types.ts           # TypeScript interfaces
│   ├── constants/         # Configuration and patterns
│   │   ├── thresholds.ts  # Numeric limits
│   │   └── patterns.ts    # Regex patterns
│   ├── helpers/           # Complex functions (30+ lines)
│   │   ├── analyzer.ts    # Main analysis logic
│   │   └── validator.ts   # Input validation
│   └── utils/             # Cross-cutting utilities
│       ├── formatter.ts   # Output formatting
│       └── cache.ts       # Caching helpers
├── tests/
│   ├── main-logic.test.ts
│   ├── helpers/
│   │   ├── analyzer.test.ts
│   │   └── validator.test.ts
│   └── fixtures/          # Test data
├── dist/                  # Generated by TypeScript
├── package.json
├── tsconfig.json
├── vitest.config.ts
├── LICENSE
└── README.md
```

## Modular Architecture Pattern

### When to Extract

**File Size Triggers:**
- Target: <300 LOC per file
- Warning: 300-500 LOC
- Critical: >500 LOC (must refactor)

### Extract to constants/

**What goes here:**
- Magic numbers (thresholds, limits)
- Configuration values
- Regex patterns
- Error messages
- Default options

**Example: constants/thresholds.ts**
```typescript
export const THRESHOLDS = {
  MAX_FILE_SIZE: 100_000,
  MAX_LINE_LENGTH: 1000,
  COMPLEXITY_WARNING: 50,
  COMPLEXITY_ERROR: 70,
  MIN_COVERAGE: 70
};

export const TIMEOUTS = {
  ANALYSIS: 30_000,  // 30s
  CACHE_TTL: 1800_000 // 30min
};
```

### Extract to helpers/

**What goes here:**
- Complex business logic (30+ lines)
- Independently testable functions
- Domain-specific calculations
- Algorithm implementations

**Example: helpers/analyzer.ts**
```typescript
import { THRESHOLDS } from '../constants/thresholds.js';

export async function analyzeComplexity(
  code: string,
  config?: ComplexityConfig
): Promise<ComplexityResult> {
  // 50+ lines of complex analysis logic
  // Extracted from main-logic.ts
}

export function calculateMetrics(
  ast: ASTNode
): Metrics {
  // 40+ lines of metric calculations
}
```

### Extract to utils/

**What goes here:**
- Cross-cutting concerns
- Shared utilities across modules
- Generic helper functions
- Format/parse utilities

**Example: utils/formatter.ts**
```typescript
export function formatOutput(
  data: any,
  format: 'json' | 'table' | 'markdown'
): string {
  // Formatting logic used by multiple helpers
}

export function parseConfig(
  input: unknown
): ValidConfig {
  // Config parsing shared across modules
}
```

## Real-World Examples

### security-scanner (Best Example)

**Before:** 395 LOC monolithic file
**After:** 209 LOC main + modular structure

```
src/
├── mcp-server.ts          # 120 LOC (thin orchestration)
├── scanner.ts             # 89 LOC (core logic)
├── constants/
│   ├── security-thresholds.ts  # 45 LOC
│   └── secret-patterns.ts      # 67 LOC
└── scanners/
    ├── owasp-scanner.ts   # 112 LOC (specialized)
    └── dependency-scanner.ts  # 98 LOC (specialized)
```

**Result:** 47% reduction, better maintainability

### smart-reviewer

```
src/
├── mcp-server.ts          # 145 LOC
├── reviewer.ts            # 178 LOC
├── constants/
│   ├── review-patterns.ts # 89 LOC
│   └── severity-levels.ts # 56 LOC
├── fixers/                # Auto-fix implementations
│   ├── formatting-fixer.ts
│   ├── import-fixer.ts
│   └── type-fixer.ts
└── utils/
    └── ast-utils.ts       # AST manipulation helpers
```

## Package.json Structure

### Required Fields

```json
{
  "name": "@j0kz/{tool}-mcp",
  "version": "1.1.0",  // From version.json
  "description": "...",
  "type": "module",    // CRITICAL: ES modules
  "main": "./dist/index.js",
  "types": "./dist/index.d.ts",
  "bin": {
    "{tool}-mcp": "dist/mcp-server.js"
  },
  "files": [
    "dist",
    "README.md",
    "LICENSE"
  ]
}
```

### Required Scripts

```json
{
  "scripts": {
    "build": "tsc",
    "dev": "tsc --watch",
    "test": "vitest",
    "test:ci": "vitest run",
    "test:coverage": "vitest run --coverage",
    "start": "node dist/mcp-server.js"
  }
}
```

### Dependencies

```json
{
  "dependencies": {
    "@j0kz/shared": "^1.1.0",  // Must match version.json
    "@modelcontextprotocol/sdk": "^1.19.1",
    "typescript": "^5.3.3"
  },
  "devDependencies": {
    "@types/node": "^24.6.2",
    "vitest": "^1.0.0",
    "@vitest/coverage-v8": "^1.0.0"
  }
}
```

## TypeScript Configuration

### tsconfig.json

```json
{
  "extends": "../../tsconfig.base.json",
  "compilerOptions": {
    "outDir": "./dist",
    "rootDir": "./src",
    "module": "ES2022",
    "target": "ES2022",
    "moduleResolution": "node",
    "esModuleInterop": true,
    "strict": true
  },
  "include": ["src/**/*"],
  "exclude": ["node_modules", "dist", "tests"]
}
```

### Import Pattern (Critical!)

```typescript
// ✅ CORRECT - Always use .js extension
import { foo } from './bar.js';
import { helper } from './helpers/my-helper.js';
import { THRESHOLDS } from './constants/thresholds.js';

// ❌ WRONG - Will fail with ES modules
import { foo } from './bar';
import { foo } from './bar.ts';
```

## Validation Checklist

Before considering structure complete:

- [ ] mcp-server.ts < 150 LOC
- [ ] No file > 300 LOC
- [ ] Constants extracted to constants/
- [ ] Complex logic in helpers/
- [ ] Shared utilities in utils/
- [ ] All imports use .js extension
- [ ] Tests mirror src structure
- [ ] package.json has "type": "module"
- [ ] tsconfig extends base config
- [ ] README with examples