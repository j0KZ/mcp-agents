#!/usr/bin/env node
/* global console, process */

/**
 * Standalone Claude Skills Installer
 *
 * This script installs universal developer skills for Claude AI
 * in ANY project. It creates the .claude folder structure and
 * downloads optimized skill guides.
 *
 * Usage:
 *   npx @j0kz/claude-skills
 *   node install-claude-skills.js
 *   curl -sL https://raw.githubusercontent.com/j0KZ/mcp-agents/main/scripts/install-claude-skills.js | node
 */

import https from 'https';
import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';
import { createRequire } from 'module';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);
const require = createRequire(import.meta.url);

// Configuration
const SKILLS_CONFIG = {
  version: '1.0.0',
  baseUrl: 'https://raw.githubusercontent.com/j0KZ/mcp-agents/main/docs/universal-skills',
  skills: [
    { id: 'quick-pr-review', name: 'Quick PR Review', time: '30 seconds', impact: 'HIGH' },
    { id: 'debug-detective', name: 'Debug Detective', time: '5 minutes', impact: 'HIGH' },
    { id: 'performance-hunter', name: 'Performance Hunter', time: '10 minutes', impact: 'HIGH' },
    { id: 'legacy-modernizer', name: 'Legacy Modernizer', time: 'Incremental', impact: 'HIGH' },
    { id: 'zero-to-hero', name: 'Zero to Hero', time: '30 minutes', impact: 'HIGH' },
    { id: 'test-coverage-boost', name: 'Test Coverage Boost', time: '1-5 days', impact: 'MEDIUM' },
    { id: 'tech-debt-tracker', name: 'Tech Debt Tracker', time: '1 hour setup', impact: 'MEDIUM' },
    { id: 'dependency-doctor', name: 'Dependency Doctor', time: '30 minutes', impact: 'MEDIUM' },
    { id: 'security-first', name: 'Security First', time: '1 hour', impact: 'CRITICAL' },
    { id: 'api-integration', name: 'API Integration', time: '2 hours', impact: 'MEDIUM' }
  ]
};

// Utility functions
function downloadFile(url, filepath) {
  return new Promise((resolve, reject) => {
    const file = fs.createWriteStream(filepath);

    const request = https.get(url, (response) => {
      if (response.statusCode === 200) {
        response.pipe(file);
        file.on('finish', () => {
          file.close();
          resolve();
        });
      } else if (response.statusCode === 301 || response.statusCode === 302) {
        // Handle redirects
        file.close();
        fs.unlinkSync(filepath);
        downloadFile(response.headers.location, filepath).then(resolve).catch(reject);
      } else {
        file.close();
        fs.unlinkSync(filepath);
        reject(new Error(`HTTP ${response.statusCode}: ${response.statusMessage}`));
      }
    });

    request.on('error', (err) => {
      file.close();
      fs.unlinkSync(filepath);
      reject(err);
    });
  });
}

function showBanner() {
  console.log('\n' + '='.repeat(50));
  console.log('    üß† Claude Universal Skills Installer');
  console.log('    10 Project-Agnostic Developer Skills');
  console.log('='.repeat(50) + '\n');
}

function ensureClaudeFolder() {
  const claudeDir = path.join(process.cwd(), '.claude');

  if (!fs.existsSync(claudeDir)) {
    console.log('üìÅ Creating .claude folder for Claude configuration...');
    fs.mkdirSync(claudeDir, { recursive: true });

    // Create info file
    const infoContent = `# Claude AI Configuration

This folder contains skills and configuration for Claude AI assistant.

## Structure
- \`universal-skills/\` - Project-agnostic developer skills
- \`skills/\` - Project-specific skills (if any)
- \`CLAUDE.md\` - Project instructions for Claude

## Quick Usage
Ask Claude to use any skill:
- "Use the debug-detective skill"
- "Apply quick-pr-review checklist"
- "Follow zero-to-hero guide"

Generated by @j0kz/mcp-agents
`;
    fs.writeFileSync(path.join(claudeDir, 'README.md'), infoContent);
  }

  return claudeDir;
}

async function installSkills() {
  const claudeDir = ensureClaudeFolder();
  const skillsDir = path.join(claudeDir, 'universal-skills');

  // Create skills directory
  fs.mkdirSync(skillsDir, { recursive: true });

  console.log(`üì• Installing ${SKILLS_CONFIG.skills.length} universal skills...\n`);

  // Download INDEX first
  console.log('  üìã Downloading skills index...');
  try {
    await downloadFile(
      `${SKILLS_CONFIG.baseUrl}/INDEX.md`,
      path.join(skillsDir, 'INDEX.md')
    );
  } catch (error) {
    console.error('  ‚ùå Failed to download index:', error.message);
  }

  // Download each skill
  let successful = 0;
  let failed = 0;

  for (let i = 0; i < SKILLS_CONFIG.skills.length; i++) {
    const skill = SKILLS_CONFIG.skills[i];
    const progress = `[${i + 1}/${SKILLS_CONFIG.skills.length}]`;

    process.stdout.write(`  ${progress} ${skill.name}...`);

    const skillDir = path.join(skillsDir, skill.id);
    fs.mkdirSync(skillDir, { recursive: true });

    try {
      await downloadFile(
        `${SKILLS_CONFIG.baseUrl}/${skill.id}/SKILL.md`,
        path.join(skillDir, 'SKILL.md')
      );

      console.log(` ‚úÖ (${skill.time}, ${skill.impact} impact)`);
      successful++;
    } catch (error) {
      console.log(` ‚ùå Failed`);
      failed++;

      // Create placeholder with error info
      const placeholder = `# ${skill.name}

‚ö†Ô∏è This skill could not be downloaded automatically.

## Manual Download
View this skill online at:
${SKILLS_CONFIG.baseUrl}/${skill.id}/SKILL.md

## Description
- **Time to Apply**: ${skill.time}
- **Impact Level**: ${skill.impact}

## Error Details
${error.message}
`;
      fs.writeFileSync(path.join(skillDir, 'SKILL.md'), placeholder);
    }
  }

  // Create manifest
  const manifest = {
    version: SKILLS_CONFIG.version,
    installed: new Date().toISOString(),
    location: path.relative(process.cwd(), skillsDir),
    skills: SKILLS_CONFIG.skills.map(s => ({
      id: s.id,
      name: s.name,
      time: s.time,
      impact: s.impact,
      path: `${s.id}/SKILL.md`
    })),
    stats: {
      total: SKILLS_CONFIG.skills.length,
      successful,
      failed
    }
  };

  fs.writeFileSync(
    path.join(skillsDir, 'manifest.json'),
    JSON.stringify(manifest, null, 2)
  );

  // Create quick usage guide
  const usageGuide = `# Quick Skills Usage Guide

## Available Skills (${successful} of ${SKILLS_CONFIG.skills.length})

### High Priority Skills
1. **quick-pr-review** - "Review my changes before PR"
2. **debug-detective** - "Help me debug this issue"
3. **security-first** - "Check for security issues"

### Code Quality Skills
4. **performance-hunter** - "Find performance bottlenecks"
5. **test-coverage-boost** - "Help increase test coverage"
6. **legacy-modernizer** - "Modernize this legacy code"

### Project Understanding
7. **zero-to-hero** - "Help me understand this codebase"
8. **tech-debt-tracker** - "Track technical debt"

### Maintenance Skills
9. **dependency-doctor** - "Fix dependency issues"
10. **api-integration** - "Help integrate this API"

## How to Use

Simply ask Claude to apply a skill:
- "Use the debug-detective skill to find this bug"
- "Apply the quick-pr-review checklist"
- "Follow the zero-to-hero guide for this project"

## Skill Locations
All skills are in: \`.claude/universal-skills/\`

Each skill contains:
- Quick start guide (30 seconds)
- WITH MCP approach (if tools installed)
- WITHOUT MCP approach (manual)
- Pro tips and best practices
`;

  fs.writeFileSync(path.join(skillsDir, 'USAGE.md'), usageGuide);

  return { successful, failed, location: skillsDir };
}

async function main() {
  showBanner();

  // Check if we're in a git repository or project
  const isProject = fs.existsSync('package.json') ||
                   fs.existsSync('.git') ||
                   fs.existsSync('pom.xml') ||
                   fs.existsSync('requirements.txt') ||
                   fs.existsSync('go.mod');

  if (!isProject) {
    console.log('‚ö†Ô∏è  Warning: No project detected in current directory');
    console.log('   Current directory:', process.cwd());
    console.log('\n   It\'s recommended to run this in your project root.\n');

    const readline = (await import('readline')).createInterface({
      input: process.stdin,
      output: process.stdout
    });

    await new Promise(resolve => {
      readline.question('Continue anyway? (y/N): ', (answer) => {
        readline.close();
        if (answer.toLowerCase() !== 'y') {
          console.log('Installation cancelled.');
          process.exit(0);
        }
        resolve();
      });
    });
  }

  try {
    const result = await installSkills();

    console.log('\n' + '='.repeat(50));
    console.log('‚úÖ Installation Complete!');
    console.log('='.repeat(50));

    console.log('\nüìä Summary:');
    console.log(`  ‚Ä¢ Skills installed: ${result.successful}/${SKILLS_CONFIG.skills.length}`);
    console.log(`  ‚Ä¢ Location: ${path.relative(process.cwd(), result.location)}/`);
    console.log(`  ‚Ä¢ Size: ~500KB (optimized markdown)`);

    console.log('\nüöÄ Quick Start:');
    console.log('  1. Open this project in Claude/Cursor/VS Code');
    console.log('  2. Ask: "What universal skills are available?"');
    console.log('  3. Try: "Use debug-detective to find bugs"');

    console.log('\nüìñ Documentation:');
    console.log('  ‚Ä¢ Skills index: .claude/universal-skills/INDEX.md');
    console.log('  ‚Ä¢ Usage guide: .claude/universal-skills/USAGE.md');
    console.log('  ‚Ä¢ Online docs: https://github.com/j0KZ/mcp-agents/wiki');

    if (result.failed > 0) {
      console.log('\n‚ö†Ô∏è  Some skills failed to download.');
      console.log('   View them online or try again later.');
    }

  } catch (error) {
    console.error('\n‚ùå Installation failed:', error.message);
    console.log('\nüìñ Alternative: View skills online at:');
    console.log('   https://github.com/j0KZ/mcp-agents/tree/main/docs/universal-skills');
    process.exit(1);
  }
}

// Run if executed directly
main().catch(console.error);

// Export for use as module
export { installSkills, SKILLS_CONFIG };